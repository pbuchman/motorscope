name: Version Bump on Merge

# =============================================================================
# IMPORTANT: For protected branches, you need to create a PAT or GitHub App token
# and store it as a repository secret named VERSION_BUMP_TOKEN.
#
# Option 1: Personal Access Token (PAT)
#   - Go to: Settings > Developer settings > Personal access tokens > Fine-grained tokens
#   - Create token with "Contents: Read and write" permission for this repo
#   - Add as repository secret: Settings > Secrets > Actions > New secret
#   - Name: VERSION_BUMP_TOKEN
#
# Option 2: GitHub App
#   - Create a GitHub App with "Contents: write" permission
#   - Install on this repo
#   - Use the app's token via actions like tibdex/github-app-token
#
# If main is NOT protected, you can use GITHUB_TOKEN by setting:
#   token: ${{ secrets.GITHUB_TOKEN }}
# =============================================================================

on:
  pull_request:
    types:
      - closed
    branches:
      - main
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.github/instructions/**'

jobs:
  version-bump:
    name: Bump Extension Version
    runs-on: ubuntu-latest
    # Only run when PR is actually merged (not just closed)
    # Skip if PR title indicates it's a version bump (prevents loops)
    if: |
      github.event.pull_request.merged == true &&
      !startsWith(github.event.pull_request.title, 'chore: release')

    permissions:
      contents: write

    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use PAT to bypass branch protection; falls back to GITHUB_TOKEN if not set
          token: ${{ secrets.VERSION_BUMP_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Bump version
        id: bump
        run: |
          set -euo pipefail

          MANIFEST_FILE="extension/manifest.template.json"
          PACKAGE_FILE="extension/package.json"

          # Extract current version from manifest
          CURRENT_VERSION=$(jq -r '.version' "$MANIFEST_FILE")
          echo "Current version: $CURRENT_VERSION"

          # Parse version components (expects format: major.minor.patch)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Bump minor version, reset patch to 0
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
          echo "New version: $NEW_VERSION"

          # Update manifest.template.json
          jq --arg version "$NEW_VERSION" '.version = $version' "$MANIFEST_FILE" > tmp.json && mv tmp.json "$MANIFEST_FILE"

          # Update extension/package.json
          jq --arg version "$NEW_VERSION" '.version = $version' "$PACKAGE_FILE" > tmp.json && mv tmp.json "$PACKAGE_FILE"

          # Export for subsequent steps
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit, tag and push version bump
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          VERSION="v${{ steps.bump.outputs.new_version }}"

          git add extension/manifest.template.json extension/package.json
          git commit -m "chore: release ${VERSION}"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin main --tags

  # =============================================================================
  # Build and Package with new version
  # =============================================================================
  build-release:
    name: Build Release Artifact
    runs-on: ubuntu-latest
    needs: version-bump
    env:
      SCARF_ANALYTICS: false

    steps:
      - name: Checkout (with bumped version)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          rm -rf node_modules
          npm ci
          npm install @rollup/rollup-linux-x64-gnu lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu --save-optional

      - name: Install extension native deps
        working-directory: extension
        run: |
          mkdir -p node_modules
          npm install lightningcss lightningcss-linux-x64-gnu --legacy-peer-deps

      - name: Build Extension
        run: npm --workspace=extension exec vite build

      - name: Package artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts

          VERSION="${{ needs.version-bump.outputs.new_version }}"

          cd extension/dist
          zip -r "../../artifacts/motorscope-v${VERSION}.zip" .
          cd ../..

          if npx --yes crx@latest pack extension/dist -o "artifacts/motorscope-v${VERSION}.crx" 2>/dev/null; then
            echo "CRX created successfully"
          else
            echo "CRX creation skipped (requires signing key)"
          fi

      - name: Upload Extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: motorscope-v${{ needs.version-bump.outputs.new_version }}
          path: |
            artifacts/motorscope-*.zip
            artifacts/motorscope-*.crx
          retention-days: 90
          if-no-files-found: warn

